# Film Night Backend

Серверная часть приложения для управления коллекцией фильмов. Проект предоставляет API для регистрации пользователей, управления коллекцией фильмов, поиска фильмов, а также интеграции с внешними сервисами, такими как Yandex OAuth и MinIO для хранения изображений.

## 1. Архитектура (Взаимодействие между сервисами)

Проект построен на основе микросервисной архитектуры. Основные компоненты:

- **FastAPI Application:** Основной API-сервис, обрабатывающий запросы пользователей, взаимодействующий с базой данных, MinIO и Elasticsearch.
- **PostgreSQL:** База данных для хранения информации о пользователях, фильмах и коллекциях фильмов.
- **MinIO:** Объектное хранилище для хранения изображений (постеров фильмов, пользовательских аватарок).
- **Elasticsearch:** Поисковый движок для обеспечения полнотекстового поиска фильмов.
- **TMDB Parser:** Сервис/скрипт, отвечающий за автоматический импорт данных о фильмах из The Movie Database (TMDB) API.
- **Yandex OAuth:** Сервис аутентификации, предоставляемый Яндексом.

### Диаграмма архитектуры

![Диаграмма архитектуры](/media/diagram.jpg)

## Структура проекта

```
src/
├── __init__.py
├── app/          # Основное приложение FastAPI
│   ├── __init__.py
│   ├── api/      # API endpoints (роутеры)
│   │   ├── __init__.py
│   │   ├── endpoints/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py        # Аутентификация
│   │   │   ├── collection.py  # Управление коллекциями фильмов
│   │   │   ├── images.py      # Работа с изображениями
│   │   │   ├── movies.py      # Поиск и управление фильмами
│   │   │   └── users.py       # Управление пользователями
│   ├── core/     # Основные компоненты и настройки
│   │   ├── __init__.py
│   │   ├── config.py        # Настройки приложения (MinIO, DB, etc.)
│   │   ├── elasticsearch.py # Подключение к Elasticsearch
│   │   ├── minio_client.py  # Подключение к MinIO
│   │   └── security.py      # Безопасность (JWT, hashing)
│   ├── db.py         # Подключение к базе данных
│   ├── models/       # Модели базы данных (SQLAlchemy)
│   │   ├── __init__.py
│   │   ├── custom_movie.py # Модель пользовательского фильма
│   │   ├── movie.py       # Модель фильма
│   │   ├── user.py        # Модель пользователя
│   │   └── user_movie.py  # Модель связи пользователя и фильма 
│   ├── repositories/ # Data access layer (работа с БД)
│   │   ├── __init__.py
│   │   ├── custom_movie_repository.py
│   │   ├── movie_repository.py
│   │   ├── user_movie_repository.py
│   │   └── user_repository.py
│   ├── schemas/      # Pydantic схемы для валидации данных
│   │   ├── __init__.py
│   │   ├── collection.py# Схемы коллекций фильмов
│   │   ├── enums.py       # Enum'ы (например, MovieStatus)
│   │   ├── movie.py       # Схемы фильмов
│   │   ├── user.py        # Схемы пользователей
│   │   └── user_movie.py  # Схемы связи пользователей и фильмов
│   ├── services/     # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── custom_movie_service.py
│   │   ├── google_oauth.py # Google OAuth
│   │   ├── movie_service.py
│   │   ├── user_movie_service.py
│   │   ├── user_service.py
│   │   └── yandex_service.py# Yandex OAuth
│   └── main.py       # Основной файл приложения (создание FastAPI app)
├── tests/            # Тесты
│   ├── __init__.py
│   ├── conftest.py   # Настройки тестов (fixtures)
│   ├── test_auth.py
│   ├── test_collection.py
│   ├── test_images.py
│   └── test_movies.py
├── tools/              # Скрипты
│   └── parse-movies.py # Скрипт парсинга фильмов из TMDB
└── docker-compose.yml # Описание сервисов для Docker Compose
```

**Описание:**

- `app`: Содержит основной код приложения FastAPI.
- `api`: Определяет API endpoints, используя FastAPI роутеры.
- `core`: Содержит основные компоненты, такие как настройки, клиенты для работы с MinIO и Elasticsearch, а также функции безопасности.
- `db.py`: Содержит конфигурацию для подключения к базе данных PostgreSQL с использованием SQLAlchemy.
- `models`: Определяет модели базы данных (таблицы) с использованием SQLAlchemy.
- `repositories`: Содержит классы для работы с базой данных, предоставляющие методы для выполнения CRUD операций.
- `schemas`: Определяет Pydantic схемы, используемые для валидации данных, поступающих в API, а также для сериализации данных, отправляемых в ответах API.
- `services`: Содержит классы, реализующие бизнес-логику приложения.
- `tools`: Содержит скрипты для выполнения различных задач, таких как парсинг данных о фильмах из TMDB.
- `tests`: Содержит тесты для проверки работоспособности API.

## Описание БД

База данных PostgreSQL содержит следующие таблицы:

- **users:** Информация о пользователях (id, username, email, hashed_password, yandex_id, created_at, profile_picture, jwt_token, is_admin).
- **movies:** Информация о фильмах (id, tmdb_id, adult, backdrop_path, genre_ids, original_language, original_title, overview, popularity, poster_path, release_date, title, video, vote_average, vote_count).
- **custom_movies:** Информация о пользовательских фильмах (id, user_id, title, description, poster_path, created_at, updated_at).
- **user_movies:** Связь между пользователями и фильмами (коллекция фильмов) (id, user_id, movie_id, custom_movie_id, status, rating, added_at, updated_at).

### Схема базы данных

![Диаграмма БД](/media/db-diagram.jpg)

**Описание связей:**

- `user_movies` содержит внешние ключи на `users`, `movies` и `custom_movies`, реализуя связь "многие ко многим" между пользователями и фильмами (как TMDB, так и кастомными).
- В `user_movies` обеспечена целостность данных, гарантируя, что каждая запись связана либо с TMDB фильмом, либо с пользовательским, но не с обоими одновременно.

## Описание Pipeline

Ссылка на описание pipeline: [тык](/.gitlab-ci.yml)

### Ссылка на последний успешный Pipeline

https://REDACTED/team-3/backend/-/pipelines/18505

### Ссылка на OpenAPI спецификацию

https://prod-team-3-uad8jq68.REDACTED/openapi.json

### Ссылка на Swagger UI

https://prod-team-3-uad8jq68.REDACTED/docs

### Описание работы Swagger UI

Swagger UI предоставляет интерактивный интерфейс для работы с API.

**Моковые данные:**

Примеры запросов и ответов можно найти в документации каждого endpoint. Вы можете скопировать примеры JSON-запросов и использовать их для тестирования API.

## Ссылка на тестовые сценарии

Тестовые сценарии находятся в директории `tests/`. Каждый файл содержит тесты для определенного модуля API. Например:

- `tests/test_auth.py`: Тесты для аутентификации.
- `tests/test_collection.py`: Тесты для управления коллекциями фильмов.
- `tests/test_images.py`: Тесты для работы с изображениями.
- `tests/test_movies.py`: Тесты для поиска и управления фильмами.
- `tests/test_users.py`: Тесты для работы с пользователями.

**Примеры тестовых сценариев:**

- Регистрация нового пользователя с валидными данными.
- Регистрация пользователя с уже существующим email.
- Авторизация пользователя с верными учетными данными.
- Попытка авторизации с неверным паролем.
- Добавление фильма в коллекцию пользователя.
- Обновление статуса фильма в коллекции.
- Удаление фильма из коллекции.
- Поиск фильмов по названию.
- Фильтрация фильмов по жанру.
- Загрузка изображения.


**Описание покрытия:**

- Основные endpoints API (аутентификация, коллекции фильмов, поиск фильмов)
- Протестирована обработка основных сценариев (успешные запросы, ошибки валидации, ошибки авторизации).
- Некоторые редкие сценарии и обработка исключений могут быть не полностью покрыты тестами.

## Установка и запуск

### Требования

- Docker
- Docker Compose

### Запуск проекта

Запустите проект с помощью Docker Compose:

```bash
docker-compose up --build
```

После запуска сервера, документация API будет доступна по адресу: `https://localhost/docs`.
